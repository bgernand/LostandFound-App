{% extends "base.html" %}
{% block content %}

<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title mb-1">Items Overview</h5>
    <div class="text-muted small mb-3">Filter, search and manage all lost/found items.</div>

    <form class="row g-2" method="get" action="{{ url_for('index') }}">
      <div class="col-12 col-lg-4">
        <label class="form-label small text-muted mb-1">Search</label>
        <input class="form-control" name="q" placeholder="Search (title, name, location...)" value="{{ q }}">
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Type</label>
        <select class="form-select" name="kind">
          <option value="" {% if not kinds_selected %}selected{% endif %}>All</option>
          <option value="lost" {% if 'lost' in kinds_selected %}selected{% endif %}>Lost Request</option>
          <option value="found" {% if 'found' in kinds_selected %}selected{% endif %}>Found Item</option>
        </select>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <label class="form-label small text-muted mb-1">Status</label>
        <select class="form-select" name="status" multiple size="4">
          {% for s in statuses %}
            <option value="{{s}}" {% if s in statuses_selected %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <label class="form-label small text-muted mb-1">Category</label>
        <select class="form-select" name="category" multiple size="4">
          {% for c in categories %}
            <option value="{{c}}" {% if c in categories_selected %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Linked</label>
        <select class="form-select" name="linked">
          <option value="" {% if not linked_state %}selected{% endif %}>All</option>
          <option value="linked" {% if linked_state=='linked' %}selected{% endif %}>Linked only</option>
          <option value="unlinked" {% if linked_state=='unlinked' %}selected{% endif %}>Unlinked only</option>
        </select>
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Date from</label>
        <input class="form-control" type="date" name="date_from" value="{{ date_from or '' }}">
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Date to</label>
        <input class="form-control" type="date" name="date_to" value="{{ date_to or '' }}">
      </div>
      <div class="col-12 col-lg-3">
        <label class="form-label small text-muted mb-1">Quick date presets</label>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-outline-secondary js-date-preset" type="button" data-preset="last7">Last 7 days</button>
          <button class="btn btn-sm btn-outline-secondary js-date-preset" type="button" data-preset="last30">Last 30 days</button>
          <button class="btn btn-sm btn-outline-secondary js-date-preset" type="button" data-preset="month">This month</button>
        </div>
      </div>
      <div class="col-12 small text-muted">
        Multi-select: use Ctrl/Cmd + click.
      </div>
      <div class="col-12 d-grid d-md-flex gap-2">
        <button class="btn btn-primary" type="submit">Apply filters</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Clear all filters</a>
      </div>
    </form>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <h6 class="card-title mb-2">Saved Searches</h6>
    <div class="row g-2">
      <div class="col-12 col-lg-6">
        <form class="d-flex gap-2" method="post" action="{{ url_for('saved_search_open') }}">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="next" value="{{ current_path }}">
          <select class="form-select" name="saved_search_id">
            <option value="">Saved searches...</option>
            {% for s in saved_searches %}
              <option value="{{ s['id'] }}">{{ s['name'] }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-secondary" type="submit">Open</button>
          <button class="btn btn-outline-danger" type="submit"
                  formaction="{{ url_for('saved_search_delete_post') }}" formmethod="post">Delete</button>
        </form>
      </div>
      <div class="col-12 col-lg-6">
        <form class="d-flex gap-2" method="post" action="{{ url_for('saved_search_create') }}">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="scope" value="index">
          <input type="hidden" name="next" value="{{ current_path }}">
          <input type="hidden" name="query_string" value="{{ current_query }}">
          <input class="form-control" name="name" maxlength="80" placeholder="Name for current search">
          <button class="btn btn-outline-primary" type="submit">Save current search</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <div class="small text-muted">Items found: {{ items|length }}</div>
  <div class="d-flex gap-2">
    <form method="get" action="{{ url_for('export_csv') }}" class="d-inline">
      <input type="hidden" name="q" value="{{ q }}">
      {% for v in kinds_selected %}
        <input type="hidden" name="kind" value="{{ v }}">
      {% endfor %}
      {% for v in statuses_selected %}
        <input type="hidden" name="status" value="{{ v }}">
      {% endfor %}
      {% for v in categories_selected %}
        <input type="hidden" name="category" value="{{ v }}">
      {% endfor %}
      <input type="hidden" name="linked" value="{{ linked_state }}">
      <input type="hidden" name="include_lost_forever" value="{{ include_lost_forever }}">
      <input type="hidden" name="date_from" value="{{ date_from }}">
      <input type="hidden" name="date_to" value="{{ date_to }}">
      <button class="btn btn-sm btn-outline-secondary" type="submit">Export CSV</button>
    </form>
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('matches_overview') }}">Open Possible Matches</a>
  </div>
</div>

{% if open_reminders and open_reminders > 0 %}
  <div class="alert alert-warning py-2">
    {{ open_reminders }} follow-up reminder(s) are open.
    <a href="{{ url_for('dashboard') }}" class="alert-link">Open dashboard</a>
  </div>
{% endif %}

<form method="post" action="{{ url_for('bulk_status_update') }}">
  <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
  <div class="list-group">
    {% for item in items %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div class="d-flex gap-2 align-items-start me-2">
            {% if can_write %}
              <input class="form-check-input mt-1" type="checkbox" name="item_ids" value="{{ item['id'] }}">
            {% endif %}
            <div>
              <div class="fw-bold">
                <a class="text-decoration-none" href="{{ url_for('detail', item_id=item['id']) }}">
                  {% if item['kind'] == 'lost' %}ðŸ”Ž Lost Request:{% else %}ðŸ“¦ Found Item:{% endif %}
                  {{ item['title'] }}
                </a>
                {% set pc = photo_counts.get(item['id'], 0) %}
                {% if pc %}
                  <span class="badge text-bg-info ms-2">ðŸ“· {{ pc }}</span>
                {% endif %}
                {% if item['id'] in linked_item_ids %}
                  <span class="badge text-bg-success ms-2">Linked</span>
                {% endif %}
              </div>
              <div class="text-muted small">
                {{ item['category'] }} Â· {{ item['location'] or "â€”" }} Â· {{ item['event_date'] or "â€”" }}
              </div>
            </div>
          </div>
          <span class="badge text-bg-{{ STATUS_COLORS.get(item['status'], 'secondary') }} align-self-start">
            {{ item['status'] }}
          </span>
        </div>
      </div>
    {% else %}
      <div class="text-muted">No items found.</div>
    {% endfor %}
  </div>
  {% if can_write and items %}
    <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
      <label class="small text-muted mb-0" for="bulkStatusSel">Bulk action:</label>
      <select class="form-select form-select-sm" id="bulkStatusSel" name="bulk_status" style="max-width: 240px;">
        {% for s in statuses %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-sm btn-outline-primary" type="submit">Apply to selected</button>
    </div>
  {% endif %}
</form>

<form class="mt-3 d-flex align-items-center gap-2" method="get" action="{{ url_for('index') }}">
  <input type="hidden" name="q" value="{{ q }}">
  {% for v in kinds_selected %}
    <input type="hidden" name="kind" value="{{ v }}">
  {% endfor %}
  {% for v in statuses_selected %}
    <input type="hidden" name="status" value="{{ v }}">
  {% endfor %}
  {% for v in categories_selected %}
    <input type="hidden" name="category" value="{{ v }}">
  {% endfor %}
  <input type="hidden" name="linked" value="{{ linked_state }}">
  <input type="hidden" name="date_from" value="{{ date_from }}">
  <input type="hidden" name="date_to" value="{{ date_to }}">
  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="include_lost_forever" value="1" id="includeLostForeverBottom"
           {% if include_lost_forever==1 %}checked{% endif %}
           onchange="this.form.submit()">
    <label class="form-check-label" for="includeLostForeverBottom">Show items with status "Lost forever"</label>
  </div>
</form>

<script>
  (function () {
    const fromInput = document.querySelector('input[name="date_from"]');
    const toInput = document.querySelector('input[name="date_to"]');
    if (!fromInput || !toInput) return;

    function toIsoDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function setRange(daysBack) {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - daysBack);
      fromInput.value = toIsoDate(start);
      toInput.value = toIsoDate(end);
    }

    document.querySelectorAll('.js-date-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = btn.getAttribute('data-preset');
        if (preset === 'last7') {
          setRange(7);
        } else if (preset === 'last30') {
          setRange(30);
        } else if (preset === 'month') {
          const now = new Date();
          const start = new Date(now.getFullYear(), now.getMonth(), 1);
          fromInput.value = toIsoDate(start);
          toInput.value = toIsoDate(now);
        }
      });
    });
  })();
</script>

{% endblock %}
