{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start gap-2">
      <div>
        <h5 class="card-title mb-1">
          {% if item['kind'] == 'lost' %}ðŸ”Ž Lost Request:{% else %}ðŸ“¦ Found Item:{% endif %}
          {{ item['title'] }}
        </h5>
        <div class="text-muted small">
          Created: {{ item['created_at'] }}{% if item['updated_at'] %} Â· Updated: {{ item['updated_at'] }}{% endif %}
        </div>
      </div>
      <span class="badge text-bg-{{ STATUS_COLORS.get(item['status'], 'secondary') }}">
        {{ item['status'] }}
      </span>
    </div>

    <hr>

    <dl class="row">
      <dt class="col-sm-3">Category</dt><dd class="col-sm-9">{{ item['category'] }}</dd>
      <dt class="col-sm-3">Location</dt><dd class="col-sm-9">{{ item['location'] or "â€”" }}</dd>
      <dt class="col-sm-3">Date Lost / Found</dt><dd class="col-sm-9">{{ item['event_date'] or "â€”" }}</dd>
      <dt class="col-sm-3">Description</dt><dd class="col-sm-9">{{ item['description'] or "â€”" }}</dd>
      <dt class="col-sm-3">Notes</dt><dd class="col-sm-9">{{ item['lost_notes'] or "â€”" }}</dd>
    </dl>

    {% if item['kind'] == 'lost' %}
      <hr>
      <h6>Lost details (internal)</h6>
      <dl class="row">
        <dt class="col-sm-3">Last Name</dt><dd class="col-sm-9">{{ item['lost_last_name'] or "â€”" }}</dd>
        <dt class="col-sm-3">First Name</dt><dd class="col-sm-9">{{ item['lost_first_name'] or "â€”" }}</dd>
        <dt class="col-sm-3">Groupleader</dt><dd class="col-sm-9">{{ item['lost_group_leader'] or "â€”" }}</dd>

        <dt class="col-sm-3">Street</dt>
        <dd class="col-sm-9">
          {{ item['lost_street'] or "" }} {{ item['lost_number'] or "" }}
          {% if item['lost_additional'] %}<span class="text-muted">({{ item['lost_additional'] }})</span>{% endif %}
        </dd>

        <dt class="col-sm-3">Postcode / Town</dt><dd class="col-sm-9">{{ item['lost_postcode'] or "" }} {{ item['lost_town'] or "" }}</dd>
        <dt class="col-sm-3">Country</dt><dd class="col-sm-9">{{ item['lost_country'] or "â€”" }}</dd>

        <dt class="col-sm-3">E-Mail</dt>
        <dd class="col-sm-9">
          {% if item['lost_email'] %}
            <a href="mailto:{{ item['lost_email'] }}">{{ item['lost_email'] }}</a>
          {% else %}
            â€”
          {% endif %}
        </dd>
        <dt class="col-sm-3">Phone</dt>
        <dd class="col-sm-9">
          {% if item['lost_phone'] %}
            <a href="tel:{{ item['lost_phone']|replace(' ', '') }}">{{ item['lost_phone'] }}</a>
          {% else %}
            â€”
          {% endif %}
        </dd>

        <dt class="col-sm-3">Leaving TaizÃ©</dt><dd class="col-sm-9">{{ item['lost_leaving_date'] or "â€”" }}</dd>
        <dt class="col-sm-3">Way of contact</dt><dd class="col-sm-9">{{ item['lost_contact_way'] or "â€”" }}</dd>

        <dt class="col-sm-3">Postage</dt>
        <dd class="col-sm-9">
          {{ item['postage_price'] if item['postage_price'] is not none else "â€”" }}
          Â· Paid:
          {% if item['postage_paid'] == 1 or item['postage_paid'] == '1' %}
            <span class="badge text-bg-success">Yes</span>
          {% else %}
            <span class="badge text-bg-secondary">No</span>
          {% endif %}
        </dd>
      </dl>
    {% endif %}

    <hr>
    <div class="fw-bold mb-2">Linked {{ "Found Items" if item['kind'] == 'lost' else "Lost Requests" }}</div>
    {% if linked_items and linked_items|length %}
      <ul class="list-group mb-3">
        {% for li in linked_items %}
          <li class="list-group-item d-flex justify-content-between align-items-center gap-2">
            <div>
              <a href="{{ url_for('detail', item_id=li['id']) }}">
                #{{ li['id'] }} - {{ li['title'] }}
              </a>
              <div class="small text-muted">
                {{ li['kind'] }} Â· {{ li['status'] }} Â· linked at {{ li['link_created_at'] }}
              </div>
            </div>
            <form method="post" action="{{ url_for('delete_link', item_id=item['id'], target_id=li['id']) }}"
                  onsubmit="return confirm('Remove this link?');">
              <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">Unlink</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted small mb-3">No links yet.</div>
    {% endif %}

    <form class="row g-2 align-items-end mb-3" method="post" action="{{ url_for('create_link', item_id=item['id']) }}">
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
      <div class="col-12 col-md-6">
        <label class="form-label">Link by item ID</label>
        <input class="form-control" name="target_item_id" placeholder='Enter {{ "Found Item" if item["kind"]=="lost" else "Lost Request" }} ID'>
      </div>
      <div class="col-12 col-md-auto">
        <button class="btn btn-outline-primary" type="submit">Create link</button>
      </div>
    </form>

    <form class="row g-2 align-items-end mb-2" method="get" action="{{ url_for('detail', item_id=item['id']) }}">
      <div class="col-12 col-md-6">
        <label class="form-label">Search and link</label>
        <input class="form-control" name="link_q" value="{{ link_q or '' }}"
               placeholder='Search {{ "Found Items" if item["kind"]=="lost" else "Lost Requests" }} by ID, title, description, category, location'>
      </div>
      <div class="col-12 col-md-auto">
        <button class="btn btn-outline-secondary" type="submit">Search</button>
      </div>
    </form>

    {% if link_q %}
      <div class="small text-muted mb-2">
        Search results for "{{ link_q }}"
      </div>
      {% if link_candidates and link_candidates|length %}
        <ul class="list-group mb-3">
          {% for c in link_candidates %}
            <li class="list-group-item d-flex justify-content-between align-items-center gap-2">
              <div>
                <a href="{{ url_for('detail', item_id=c['id']) }}">
                  #{{ c['id'] }} - {{ c['title'] }}
                </a>
                <div class="small text-muted">
                  {{ c['kind'] }} Â· {{ c['status'] }} Â· {{ c['category'] }} Â· {{ c['location'] or "â€”" }}
                </div>
              </div>
              <form method="post" action="{{ url_for('create_link', item_id=item['id']) }}">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="target_item_id" value="{{ c['id'] }}">
                <button class="btn btn-sm btn-outline-primary" type="submit">Link</button>
              </form>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-muted small mb-3">No matching items found.</div>
      {% endif %}
    {% endif %}

    {% if photos and photos|length %}
      <hr>
      <div class="fw-bold mb-2">Photos</div>
      <div class="d-flex flex-wrap gap-2">
        {% for p in photos %}
          <div class="border rounded p-2 bg-white">
            <a href="{{ url_for('uploaded_file', filename=p['filename']) }}" target="_blank" rel="noopener noreferrer">
              <img class="img-fluid" src="{{ url_for('uploaded_file', filename=p['filename']) }}" style="max-height:160px;">
            </a>
            <div class="mt-2 d-flex justify-content-between align-items-center gap-2">
              <small class="text-muted">{{ p['uploaded_at'] }}</small>
              <form method="post" action="{{ url_for('delete_photo', photo_id=p['id']) }}"
                    onsubmit="return confirm('Delete this photo?');">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <hr>

    <div class="d-flex flex-column flex-sm-row flex-wrap gap-2">
      <a class="btn btn-primary" href="{{ url_for('edit_item', item_id=item['id']) }}">Edit</a>
      <a class="btn btn-outline-primary" href="{{ url_for('receipt', item_id=item['id']) }}">Receipt</a>

      {% if (item['public_enabled'] == 1 or item['public_enabled'] == '1') %}
        <a class="btn btn-outline-secondary" href="{{ url_for('item_qr', item_id=item['id']) }}" target="_blank" rel="noopener noreferrer">QR PNG</a>
        <a class="btn btn-outline-info" href="{{ url_for('public_view', token=item['public_token']) }}" target="_blank" rel="noopener noreferrer">Public view</a>
      {% endif %}

      <form method="post" action="{{ url_for('toggle_public', item_id=item['id']) }}"
            onsubmit="return confirm('Toggle public link?');">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-outline-warning" type="submit">
          {% if item['public_enabled'] == 1 or item['public_enabled'] == '1' %}
            Lock public link
          {% else %}
            Enable public link
          {% endif %}
        </button>
      </form>

      <form method="post" action="{{ url_for('toggle_public_photos', item_id=item['id']) }}"
            onsubmit="return confirm('Toggle public photos visibility?');">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-outline-secondary" type="submit">
          {% if item['public_photos_enabled'] == 1 or item['public_photos_enabled'] == '1' %}
            Privacy: public photos OFF
          {% else %}
            Privacy: public photos ON
          {% endif %}
        </button>
      </form>

      {% if user and user['role'] == 'admin' %}
        <form method="post" action="{{ url_for('regenerate_public_token', item_id=item['id']) }}"
              onsubmit="return confirm('Regenerate public link? The old one will stop working.');">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-outline-danger" type="submit">Regenerate public link</button>
        </form>

        <form method="post" action="{{ url_for('delete_item', item_id=item['id']) }}"
              onsubmit="return confirm('Delete this item? (Admin)');">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          <button class="btn btn-outline-danger" type="submit">Delete</button>
        </form>
      {% endif %}

      <a class="btn btn-outline-secondary ms-sm-auto" href="{{ url_for('index') }}">Back</a>
    </div>
  </div>
</div>

{% if matches and matches|length %}
  <div class="mt-3">
    <div class="fw-bold mb-2">Possible matches</div>
    <div class="list-group">
      {% for m in matches %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-semibold">
                <a href="{{ url_for('detail', item_id=m['id']) }}">
                  #{{ m['id'] }} {{ "Lost Request" if m['kind']=="lost" else "Found Item" }}: {{ m['title'] }}
                </a>
              </div>
              <div class="small text-muted">
                {{ m['category'] }} Â· {{ m['location'] or "â€”" }}
              </div>
            </div>
            <div class="text-end">
              {% if m.get('match_score') is not none %}
                {% set score_color = 'secondary' %}
                {% if m['match_score'] >= 80 %}
                  {% set score_color = 'success' %}
                {% elif m['match_score'] >= 55 %}
                  {% set score_color = 'warning' %}
                {% elif m['match_score'] >= 35 %}
                  {% set score_color = 'info' %}
                {% endif %}
                <span class="badge text-bg-{{ score_color }}">Score {{ m['match_score'] }}</span>
              {% endif %}
              <div class="mt-1">
                {% for reason in (m.get('match_reasons') or []) %}
                  <span class="badge text-bg-secondary">{{ reason }}</span>
                {% endfor %}
              </div>
              <form class="mt-2" method="post" action="{{ url_for('create_link', item_id=item['id']) }}">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="target_item_id" value="{{ m['id'] }}">
                <button class="btn btn-sm btn-outline-primary" type="submit">Link</button>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

{% endblock %}
