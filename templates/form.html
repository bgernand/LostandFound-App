{% extends "base.html" %}
{% block content %}
{% set errors = errors if errors is defined else {} %}

<div class="card">
  <div class="card-body">
    <h5 class="card-title">{{ "Edit item" if item else "New item" }}</h5>
    {% if errors and errors|length %}
      <div class="alert alert-danger mt-3" role="alert">
        <div class="fw-semibold mb-1">Please fix the following fields:</div>
        <ul class="mb-0">
          {% for field, msg in errors.items() %}
            <li>
              <a href="#" class="error-link" data-field="{{ field }}">{{ msg }}</a>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post"
          enctype="multipart/form-data"
          action="{{ url_for('update_item', item_id=item['id']) if (item and item['id']) else url_for('create_item') }}"
          novalidate>
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
      <div class="row g-3">

        <div class="col-12 col-md-4">
          <label class="form-label">Type</label>
          <select class="form-select" name="kind" id="kindSel">
            <option value="lost" {% if item and item['kind']=='lost' %}selected{% endif %}>Lost Request</option>
            <option value="found" {% if item and item['kind']=='found' %}selected{% endif %}>Found Item</option>
          </select>
        </div>

        <!-- Found-only primary title -->
        <div class="col-12 col-md-8" id="titleBlock">
          <label class="form-label">What was found *</label>
          <input class="form-control {% if errors.get('title') %}is-invalid{% endif %}" name="title" id="titleInput" value="{{ item['title'] if item else '' }}">
          {% if errors.get('title') %}<div class="invalid-feedback">{{ errors.get('title') }}</div>{% endif %}
        </div>

        <!-- Lost-only primary title -->
        <div class="col-12 col-md-8 d-none" id="lostWhatBlock">
          <label class="form-label">What is lost *</label>
          <input class="form-control {% if errors.get('lost_what') %}is-invalid{% endif %}" name="lost_what" id="lostWhat"
                 value="{{ item['lost_what'] if item else '' }}">
          {% if errors.get('lost_what') %}<div class="invalid-feedback">{{ errors.get('lost_what') }}</div>{% endif %}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Status</label>
          <select class="form-select" name="status" id="statusSel">
            {% for s in statuses %}
              <option value="{{s}}" {% if item and item['status']==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Category</label>
          <select class="form-select" name="category">
            {% for c in categories %}
              <option value="{{c}}" {% if item and item['category']==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Location</label>
          <input class="form-control" name="location" value="{{ item['location'] if item else '' }}">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Date</label>
          <input class="form-control {% if errors.get('event_date') %}is-invalid{% endif %}" type="date" name="event_date"
                 value="{{ item['event_date'] if item and item['event_date'] else '' }}">
          {% if errors.get('event_date') %}<div class="invalid-feedback">{{ errors.get('event_date') }}</div>{% endif %}
        </div>

        <div class="col-12" id="descBlock">
          <label class="form-label">Description <span class="text-danger">*</span></label>
          <textarea class="form-control {% if errors.get('description') %}is-invalid{% endif %}" rows="3" name="description" id="descInput">{{ item['description'] if item else '' }}</textarea>
          {% if errors.get('description') %}<div class="invalid-feedback">{{ errors.get('description') }}</div>{% endif %}
        </div>

        <div class="col-12">
          <label class="form-label">Notes</label>
          <textarea class="form-control" rows="3" name="lost_notes">{{ item['lost_notes'] if item else '' }}</textarea>
        </div>

        <!-- LOST DETAILS -->
        <div class="col-12" id="lostFields">
          <hr>
          <h6 class="mb-3">Lost form (internal)</h6>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Last Name *</label>
              <input class="form-control {% if errors.get('lost_last_name') %}is-invalid{% endif %}" name="lost_last_name"
                     value="{{ item['lost_last_name'] if item else '' }}">
              {% if errors.get('lost_last_name') %}<div class="invalid-feedback">{{ errors.get('lost_last_name') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">First Name *</label>
              <input class="form-control {% if errors.get('lost_first_name') %}is-invalid{% endif %}" name="lost_first_name"
                     value="{{ item['lost_first_name'] if item else '' }}">
              {% if errors.get('lost_first_name') %}<div class="invalid-feedback">{{ errors.get('lost_first_name') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Street *</label>
              <input class="form-control {% if errors.get('lost_street') %}is-invalid{% endif %}" name="lost_street"
                     value="{{ item['lost_street'] if item else '' }}">
              {% if errors.get('lost_street') %}<div class="invalid-feedback">{{ errors.get('lost_street') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Number *</label>
              <input class="form-control {% if errors.get('lost_number') %}is-invalid{% endif %}" name="lost_number"
                     value="{{ item['lost_number'] if item else '' }}">
              {% if errors.get('lost_number') %}<div class="invalid-feedback">{{ errors.get('lost_number') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Additional (floor, etc.)</label>
              <input class="form-control" name="lost_additional"
                     value="{{ item['lost_additional'] if item else '' }}">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Postcode *</label>
              <input class="form-control {% if errors.get('lost_postcode') %}is-invalid{% endif %}" name="lost_postcode"
                     value="{{ item['lost_postcode'] if item else '' }}">
              {% if errors.get('lost_postcode') %}<div class="invalid-feedback">{{ errors.get('lost_postcode') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Town *</label>
              <input class="form-control {% if errors.get('lost_town') %}is-invalid{% endif %}" name="lost_town"
                     value="{{ item['lost_town'] if item else '' }}">
              {% if errors.get('lost_town') %}<div class="invalid-feedback">{{ errors.get('lost_town') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Country *</label>
              <input class="form-control {% if errors.get('lost_country') %}is-invalid{% endif %}" name="lost_country"
                     value="{{ item['lost_country'] if item else '' }}">
              {% if errors.get('lost_country') %}<div class="invalid-feedback">{{ errors.get('lost_country') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">E-Mail address *</label>
              <input class="form-control {% if errors.get('lost_email') %}is-invalid{% endif %}" type="email" name="lost_email"
                     value="{{ item['lost_email'] if item else '' }}">
              {% if errors.get('lost_email') %}<div class="invalid-feedback">{{ errors.get('lost_email') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Phone number (with countrycode: +….) *</label>
              <input class="form-control {% if errors.get('lost_phone') %}is-invalid{% endif %}" name="lost_phone"
                     value="{{ item['lost_phone'] if item else '' }}">
              {% if errors.get('lost_phone') %}<div class="invalid-feedback">{{ errors.get('lost_phone') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">When are you leaving Taizé</label>
              <input class="form-control {% if errors.get('lost_leaving_date') %}is-invalid{% endif %}" type="date" name="lost_leaving_date"
                     value="{{ item['lost_leaving_date'] if item and item['lost_leaving_date'] else '' }}">
              {% if errors.get('lost_leaving_date') %}<div class="invalid-feedback">{{ errors.get('lost_leaving_date') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Way of contact</label>
              <select class="form-select {% if errors.get('lost_contact_way') %}is-invalid{% endif %}" name="lost_contact_way">
                <option value="">—</option>
                {% for w in CONTACT_WAYS %}
                  <option value="{{ w }}" {% if item and item['lost_contact_way']==w %}selected{% endif %}>{{ w }}</option>
                {% endfor %}
              </select>
              {% if errors.get('lost_contact_way') %}<div class="invalid-feedback">{{ errors.get('lost_contact_way') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Name of Groupleader</label>
              <input class="form-control" name="lost_group_leader"
                     value="{{ item['lost_group_leader'] if item else '' }}">
            </div>

            <div class="col-12"><hr class="my-1"></div>

            <div class="col-12 col-md-4">
              <label class="form-label">Price of postage</label>
              <input class="form-control {% if errors.get('postage_price') %}is-invalid{% endif %}" name="postage_price" inputmode="decimal"
                     value="{{ item['postage_price'] if item and item['postage_price'] is not none else '' }}">
              {% if errors.get('postage_price') %}<div class="invalid-feedback">{{ errors.get('postage_price') }}</div>{% endif %}
            </div>

            <div class="col-12 col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="postage_paid" id="postagePaid"
                       {% if item and (item['postage_paid']==1 or item['postage_paid']=='1') %}checked{% endif %}>
                <label class="form-check-label" for="postagePaid">Paid</label>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Photos (PNG/JPG/WEBP, multiple allowed)</label>
          <input class="form-control" type="file" name="photos" multiple>
          <div class="text-muted small mt-1">Uploads are appended (existing photos remain).</div>
        </div>

        <div class="col-12 d-grid d-sm-flex gap-2">
          <button class="btn btn-primary" type="submit">Save</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Cancel</a>
        </div>
      </div>
    </form>
  </div>
</div>

{% if matches and matches|length %}
  <div class="alert alert-warning mt-3">
    <div class="fw-bold">Possible matches:</div>
    <ul class="mb-0">
      {% for m in matches %}
        <li>
          <a href="{{ url_for('detail', item_id=m['id']) }}">
            #{{ m['id'] }} – {{ m['kind'] }} – {{ m['title'] }} ({{ m['category'] }}, {{ m['location'] or "—" }})
          </a>
          {% if m.get('match_score') %}
            <span class="badge text-bg-dark ms-1">Score {{ m['match_score'] }}</span>
          {% endif %}
          {% if m.get('match_reasons') %}
            {% for reason in m['match_reasons'] %}
              <span class="badge text-bg-secondary ms-1">{{ reason }}</span>
            {% endfor %}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<script>
  const kindSel = document.getElementById('kindSel');
  const lostFields = document.getElementById('lostFields');
  const lostWhatBlock = document.getElementById('lostWhatBlock');
  const titleBlock = document.getElementById('titleBlock');
  const titleInput = document.getElementById('titleInput');
  const lostWhat = document.getElementById('lostWhat');
  const statusSel = document.getElementById('statusSel');
  const isEdit = {{ "true" if item else "false" }};

  // Fields required ONLY for Lost Request
  const lostRequiredNames = [
    "lost_what",
    "lost_last_name",
    "lost_first_name",
    "lost_street",
    "lost_number",
    "lost_postcode",
    "lost_town",
    "lost_country",
    "lost_email",
    "lost_phone",
  ];

  function setRequiredByName(names, required) {
    names.forEach(n => {
      const el = document.querySelector(`[name="${n}"]`);
      if (el) el.required = required;
    });
  }

  function sync() {
    const isLost = kindSel && kindSel.value === 'lost';

    // show/hide lost block
    if (lostFields) lostFields.classList.toggle('d-none', !isLost);
    if (lostWhatBlock) lostWhatBlock.classList.toggle('d-none', !isLost);

    // title should be required only for Found Item
    if (titleBlock) titleBlock.classList.toggle('d-none', isLost);
    if (titleInput) titleInput.required = !isLost;

    // lost fields are required only for Lost Request
    setRequiredByName(lostRequiredNames, isLost);

    // auto-fill title from what is lost
    if (isLost && titleInput && lostWhat) {
      titleInput.value = lostWhat.value || "";
    }

    // New item default status
    if (!isEdit && statusSel) {
      statusSel.value = "Lost";
    }
  }

  if (kindSel) kindSel.addEventListener('change', sync);
  if (lostWhat) lostWhat.addEventListener('input', sync);
  sync();

  document.querySelectorAll('.error-link').forEach(link => {
    link.addEventListener('click', (ev) => {
      ev.preventDefault();
      const field = link.getAttribute('data-field');
      if (!field) return;
      const target = document.querySelector(`[name="${field}"]`);
      if (!target) return;
      target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      target.focus({ preventScroll: true });
    });
  });
</script>

{% endblock %}
