{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="card-body">
    <h5 class="card-title">{{ "Edit item" if item else "New item" }}</h5>

    <form method="post"
          enctype="multipart/form-data"
          action="{{ url_for('update_item', item_id=item['id']) if item else url_for('create_item') }}">
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
      <div class="row g-3">

        <div class="col-12 col-md-4">
          <label class="form-label">Type</label>
          <select class="form-select" name="kind" id="kindSel">
            <option value="lost" {% if item and item['kind']=='lost' %}selected{% endif %}>Lost Request</option>
            <option value="found" {% if item and item['kind']=='found' %}selected{% endif %}>Found Item</option>
          </select>
        </div>

        <!-- Title is kept for 'found'. For 'lost' it will be auto-filled from "What is lost" -->
        <div class="col-12 col-md-8" id="titleBlock">
          <label class="form-label">Title *</label>
          <input class="form-control" name="title" id="titleInput" required value="{{ item['title'] if item else '' }}">
          <div class="form-text">For “Lost”, this is auto-filled from “What is lost”.</div>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Status</label>
          <select class="form-select" name="status">
            {% for s in statuses %}
              <option value="{{s}}" {% if item and item['status']==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Category</label>
          <select class="form-select" name="category">
            {% for c in categories %}
              <option value="{{c}}" {% if item and item['category']==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Location</label>
          <input class="form-control" name="location" value="{{ item['location'] if item else '' }}">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Date</label>
          <input class="form-control" type="date" name="event_date"
                 value="{{ item['event_date'] if item and item['event_date'] else '' }}">
        </div>

        <div class="col-12" id="descBlock">
          <label class="form-label">Description <span class="text-danger">*</span></label>
          <textarea class="form-control" rows="3" name="description" id="descInput" required>{{ item['description'] if item else '' }}</textarea>
        </div>

        <!-- LOST DETAILS -->
        <div class="col-12" id="lostFields">
          <hr>
          <h6 class="mb-3">Lost form (internal)</h6>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">What is lost *</label>
              <input class="form-control" name="lost_what" id="lostWhat"
                     value="{{ item['lost_what'] if item else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Name of Groupleader</label>
              <input class="form-control" name="lost_group_leader"
                     value="{{ item['lost_group_leader'] if item else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Last Name *</label>
              <input class="form-control" name="lost_last_name"
                     value="{{ item['lost_last_name'] if item else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">First Name *</label>
              <input class="form-control" name="lost_first_name"
                     value="{{ item['lost_first_name'] if item else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Street *</label>
              <input class="form-control" name="lost_street"
                     value="{{ item['lost_street'] if item else '' }}">
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Number *</label>
              <input class="form-control" name="lost_number"
                     value="{{ item['lost_number'] if item else '' }}">
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Additional (floor, etc.)</label>
              <input class="form-control" name="lost_additional"
                     value="{{ item['lost_additional'] if item else '' }}">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Postcode *</label>
              <input class="form-control" name="lost_postcode"
                     value="{{ item['lost_postcode'] if item else '' }}">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Town *</label>
              <input class="form-control" name="lost_town"
                     value="{{ item['lost_town'] if item else '' }}">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Country *</label>
              <input class="form-control" name="lost_country"
                     value="{{ item['lost_country'] if item else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">E-Mail address *</label>
              <input class="form-control" type="email" name="lost_email"
                     value="{{ item['lost_email'] if item else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Phone number (with countrycode: +….) *</label>
              <input class="form-control" name="lost_phone"
                     value="{{ item['lost_phone'] if item else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">When are you leaving Taizé</label>
              <input class="form-control" type="date" name="lost_leaving_date"
                     value="{{ item['lost_leaving_date'] if item and item['lost_leaving_date'] else '' }}">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Way of contact</label>
              <select class="form-select" name="lost_contact_way">
                <option value="">—</option>
                {% for w in CONTACT_WAYS %}
                  <option value="{{ w }}" {% if item and item['lost_contact_way']==w %}selected{% endif %}>{{ w }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" rows="3" name="lost_notes">{{ item['lost_notes'] if item else '' }}</textarea>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Price of postage</label>
              <input class="form-control" name="postage_price" inputmode="decimal"
                     value="{{ item['postage_price'] if item and item['postage_price'] is not none else '' }}">
            </div>

            <div class="col-12 col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="postage_paid" id="postagePaid"
                       {% if item and (item['postage_paid']==1 or item['postage_paid']=='1') %}checked{% endif %}>
                <label class="form-check-label" for="postagePaid">Paid</label>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Photos (PNG/JPG/WEBP, multiple allowed)</label>
          <input class="form-control" type="file" name="photos" multiple>
          <div class="text-muted small mt-1">Uploads are appended (existing photos remain).</div>
        </div>

        <div class="col-12 d-grid d-sm-flex gap-2">
          <button class="btn btn-primary" type="submit">Save</button>
          <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Cancel</a>
        </div>
      </div>
    </form>
  </div>
</div>

{% if matches and matches|length %}
  <div class="alert alert-warning mt-3">
    <div class="fw-bold">Possible matches:</div>
    <ul class="mb-0">
      {% for m in matches %}
        <li>
          <a href="{{ url_for('detail', item_id=m['id']) }}">
            #{{ m['id'] }} – {{ m['kind'] }} – {{ m['title'] }} ({{ m['category'] }}, {{ m['location'] or "—" }})
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<script>
  const kindSel = document.getElementById('kindSel');
  const lostFields = document.getElementById('lostFields');
  const titleBlock = document.getElementById('titleBlock');
  const titleInput = document.getElementById('titleInput');
  const lostWhat = document.getElementById('lostWhat');

  // Fields required ONLY for Lost Request
  const lostRequiredNames = [
    "lost_what",
    "lost_last_name",
    "lost_first_name",
    "lost_street",
    "lost_number",
    "lost_postcode",
    "lost_town",
    "lost_country",
    "lost_email",
    "lost_phone",
  ];

  function setRequiredByName(names, required) {
    names.forEach(n => {
      const el = document.querySelector(`[name="${n}"]`);
      if (el) el.required = required;
    });
  }

  function sync() {
    const isLost = kindSel && kindSel.value === 'lost';

    // show/hide lost block
    if (lostFields) lostFields.classList.toggle('d-none', !isLost);

    // title should be required only for Found Item
    if (titleBlock) titleBlock.classList.toggle('d-none', isLost);
    if (titleInput) titleInput.required = !isLost;

    // lost fields are required only for Lost Request
    setRequiredByName(lostRequiredNames, isLost);

    // auto-fill title from what is lost
    if (isLost && titleInput && lostWhat) {
      titleInput.value = lostWhat.value || "";
    }
  }

  if (kindSel) kindSel.addEventListener('change', sync);
  if (lostWhat) lostWhat.addEventListener('input', sync);
  sync();
</script>

{% endblock %}
