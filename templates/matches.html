{% extends "base.html" %}
{% block content %}

<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title mb-1">Possible Matches Overview</h5>
    <div class="text-muted small mb-3">Find likely lost/found pairings with scoring and filters.</div>

    <div class="row g-2 mb-3">
      <div class="col-12 col-lg-6">
        <form class="d-flex gap-2" method="post" action="{{ url_for('saved_search_open') }}">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="next" value="{{ current_path }}">
          <select class="form-select" name="saved_search_id">
            <option value="">Saved searches...</option>
            {% for s in saved_searches %}
              <option value="{{ s['id'] }}">{{ s['name'] }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-secondary" type="submit">Open</button>
        </form>
      </div>
      <div class="col-12 col-lg-6">
        <form class="d-flex gap-2" method="post" action="{{ url_for('saved_search_create') }}">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="scope" value="matches">
          <input type="hidden" name="next" value="{{ current_path }}">
          <input type="hidden" name="query_string" value="{{ current_query }}">
          <input class="form-control" name="name" maxlength="80" placeholder="Name for current search">
          <button class="btn btn-outline-primary" type="submit">Save current search</button>
        </form>
      </div>
      {% if saved_searches %}
        <div class="col-12">
          <div class="d-flex flex-wrap gap-2">
            {% for s in saved_searches %}
              <form method="post" action="{{ url_for('saved_search_delete', search_id=s['id']) }}">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="next" value="{{ current_path }}">
                <button class="btn btn-sm btn-outline-danger" type="submit" title="Delete saved search">{{ s['name'] }} ×</button>
              </form>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    <form class="row g-2" method="get" action="{{ url_for('matches_overview') }}">
      <div class="col-12 col-lg-4">
        <label class="form-label small text-muted mb-1">Search</label>
        <input class="form-control" name="q" value="{{ q }}" placeholder="Search source items (id, title, names, location)">
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Type</label>
        <select class="form-select" name="kind">
          <option value="" {% if not kinds_selected %}selected{% endif %}>All</option>
          <option value="lost" {% if 'lost' in kinds_selected %}selected{% endif %}>Lost Request</option>
          <option value="found" {% if 'found' in kinds_selected %}selected{% endif %}>Found Item</option>
        </select>
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Source status</label>
        <select class="form-select" name="source_status" multiple size="4">
          {% for s in statuses %}
            <option value="{{ s }}" {% if s in source_statuses_selected %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Candidate status</label>
        <select class="form-select" name="candidate_status" multiple size="4">
          {% for s in statuses %}
            <option value="{{ s }}" {% if s in candidate_statuses_selected %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-6 col-lg-2">
        <label class="form-label small text-muted mb-1">Category</label>
        <select class="form-select" name="category" multiple size="4">
          {% for c in categories %}
            <option value="{{ c }}" {% if c in categories_selected %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-4 col-lg-2">
        <label class="form-label small text-muted mb-1">Min score</label>
        <input class="form-control" type="number" name="min_score" min="0" max="200" value="{{ min_score }}">
      </div>
      <div class="col-12 col-md-4 col-lg-2">
        <label class="form-label small text-muted mb-1">Source limit</label>
        <input class="form-control" type="number" name="source_limit" min="5" max="200" value="{{ source_limit }}">
      </div>
      <div class="col-12 col-md-4 col-lg-2">
        <label class="form-label small text-muted mb-1">Date from</label>
        <input class="form-control" type="date" name="date_from" value="{{ date_from or '' }}">
      </div>
      <div class="col-12 col-md-4 col-lg-2">
        <label class="form-label small text-muted mb-1">Date to</label>
        <input class="form-control" type="date" name="date_to" value="{{ date_to or '' }}">
      </div>
      <div class="col-12 col-lg-3">
        <label class="form-label small text-muted mb-1">Quick date presets</label>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-sm btn-outline-secondary js-date-preset" type="button" data-preset="last7">Last 7 days</button>
          <button class="btn btn-sm btn-outline-secondary js-date-preset" type="button" data-preset="last30">Last 30 days</button>
          <button class="btn btn-sm btn-outline-secondary js-date-preset" type="button" data-preset="month">This month</button>
        </div>
      </div>
      <div class="col-12 col-md-4 col-lg-3 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="include_linked" value="1" id="includeLinked"
                 {% if include_linked==1 %}checked{% endif %}>
          <label class="form-check-label" for="includeLinked">Include already linked pairs</label>
        </div>
      </div>
      <div class="col-12 small text-muted">
        Multi-select: use Ctrl/Cmd + click.
      </div>
      <div class="col-12 col-lg-3 d-grid d-lg-flex gap-2 align-items-end">
        <button class="btn btn-primary" type="submit">Apply filters</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('matches_overview') }}">Clear all filters</a>
      </div>
    </form>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <div class="small text-muted">Matches found: {{ pairs|length }}</div>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('index') }}">Open Items Overview</a>
</div>

<div class="list-group">
  {% for p in pairs %}
    {% set src = p['source'] %}
    {% set cand = p['candidate'] %}
    <div class="list-group-item">
      <div class="d-flex justify-content-between align-items-start gap-2">
        <div>
          <div class="fw-semibold">
            <a href="{{ url_for('detail', item_id=src['id']) }}">
              #{{ src['id'] }} {{ "Lost Request" if src['kind']=="lost" else "Found Item" }}: {{ src['title'] }}
            </a>
            <span class="mx-2">↔</span>
            <a href="{{ url_for('detail', item_id=cand['id']) }}">
              #{{ cand['id'] }} {{ "Lost Request" if cand['kind']=="lost" else "Found Item" }}: {{ cand['title'] }}
            </a>
          </div>
          <div class="small text-muted">
            {{ src['category'] }} / {{ cand['category'] }} · {{ src['location'] or "—" }} / {{ cand['location'] or "—" }}
          </div>
        </div>
        <div class="text-end">
          <span class="badge text-bg-dark">Score {{ p['score'] }}</span>
          <div class="mt-1">
            {% for r in p['reasons'] %}
              <span class="badge text-bg-secondary">{{ r }}</span>
            {% endfor %}
          </div>
          <form class="mt-2" method="post" action="{{ url_for('create_link', item_id=src['id']) }}">
            <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="target_item_id" value="{{ cand['id'] }}">
            <button class="btn btn-sm btn-outline-primary" type="submit">Link</button>
          </form>
        </div>
      </div>
    </div>
  {% else %}
    <div class="text-muted">No matches with current filters.</div>
  {% endfor %}
</div>

<script>
  (function () {
    const fromInput = document.querySelector('input[name="date_from"]');
    const toInput = document.querySelector('input[name="date_to"]');
    if (!fromInput || !toInput) return;

    function toIsoDate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function setRange(daysBack) {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - daysBack);
      fromInput.value = toIsoDate(start);
      toInput.value = toIsoDate(end);
    }

    document.querySelectorAll('.js-date-preset').forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = btn.getAttribute('data-preset');
        if (preset === 'last7') {
          setRange(7);
        } else if (preset === 'last30') {
          setRange(30);
        } else if (preset === 'month') {
          const now = new Date();
          const start = new Date(now.getFullYear(), now.getMonth(), 1);
          fromInput.value = toIsoDate(start);
          toInput.value = toIsoDate(now);
        }
      });
    });
  })();
</script>

{% endblock %}
